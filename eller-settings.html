<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ - CasseDZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- 1. Ù…ÙƒØªØ¨Ø© SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style> 
        body { font-family: 'Cairo', sans-serif; } 
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 pb-24">

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header class="bg-gray-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <div class="text-xl font-black">
                Casse<span class="text-orange-500">DZ</span> <span class="text-xs font-normal text-gray-400">| Ø´Ø±ÙŠÙƒ</span>
            </div>
            <div class="bg-gray-800 p-2 rounded-full border border-gray-700">
                <span class="text-xl">ğŸ”§</span>
            </div>
        </div>
        <!-- Ø§Ù„Ø±ØµÙŠØ¯ -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-4 shadow-lg flex justify-between items-center relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-blue-200 text-xs font-bold mb-1">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                <h2 class="text-3xl font-black text-white">1,500 <span class="text-sm font-normal">Ø¯Ø¬</span></h2>
            </div>
            <div class="text-center bg-white/10 p-2 rounded-lg backdrop-blur-sm relative z-10">
                <span class="text-green-400 font-bold text-sm">Ù†Ø´Ø· (ØªØ¬Ø±ÙŠØ¨ÙŠ)</span>
            </div>
        </div>
    </header>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹) -->
    <main class="container mx-auto px-4 mt-4 space-y-4">
        <h3 class="font-bold text-gray-500 mb-2">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©:</h3>
        
        <!-- Ù‡Ù†Ø§ Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Supabase -->
        <div id="requestsContainer" class="space-y-4">
            <div class="text-center text-gray-400 py-10">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
        </div>
    </main>

    <!-- Modal Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="offerModal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-end md:items-center justify-center">
        <div class="bg-white w-full md:w-96 rounded-t-3xl md:rounded-3xl p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-black text-gray-900">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</h3>
                <button onclick="closeModal()" class="bg-gray-100 w-8 h-8 rounded-full text-gray-500 font-bold flex items-center justify-center">âœ•</button>
            </div>
            <div id="modalDetails" class="bg-blue-50 p-3 rounded-xl mb-4 text-sm font-bold text-blue-800 border border-blue-100"></div>

            <form id="offerForm" onsubmit="submitOffer(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø±)</label>
                    <div class="relative">
                        <input type="number" id="priceInput" placeholder="12000" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg" required>
                        <span class="absolute left-4 top-4 text-gray-400 font-bold text-sm">DZD</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                    <label id="fileLabel" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <p class="text-sm text-gray-500 font-bold">Ø§Ø¶ØºØ· Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹Ø©</p>
                        </div>
                        <input type="file" id="fileInput" class="hidden" onchange="fileSelected(this)" required accept="image/*" />
                    </label>
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg mt-2 text-lg hover:bg-black">
                    ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶
                </button>
            </form>
        </div>
    </div>

    <!-- ÙƒÙˆØ¯ Javascript Ù„Ù„Ø±Ø¨Ø· -->
    <script>
        // âš ï¸âš ï¸ Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø·Ùƒ Ù‡Ù†Ø§ âš ï¸âš ï¸
        const supabaseUrl = 'YOUR_SUPABASE_URL'; 
        const supabaseKey = 'YOUR_SUPABASE_KEY'; 
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentCarDetails = "";
        let currentPartName = "";

        // 1. Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Supabase Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        async function fetchRequests() {
            const container = document.getElementById('requestsContainer');
            
            // Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ requests
            const { data, error } = await supabase
                .from('requests')
                .select('*')
                .order('created_at', { ascending: false }) // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
                .limit(20);

            if (error) {
                container.innerHTML = `<p class="text-red-500 text-center">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>`;
                console.error(error);
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
                return;
            }

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ HTML
            container.innerHTML = data.map(req => `
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-200 relative">
                    <div class="absolute top-0 left-0 bg-red-100 text-red-600 text-[10px] font-bold px-3 py-1 rounded-br-xl">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
                    <div class="flex justify-between items-start mt-2">
                        <div>
                            <h3 class="text-lg font-black text-gray-800">${req.part_name}</h3>
                            <p class="text-gray-500 font-bold text-sm">${req.car_type} â€¢ ${req.year}</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded-lg text-center">
                            <span class="block text-xs text-gray-400">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                            <span class="font-bold text-blue-600 text-xs">${req.status === 'pending' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«' : req.status}</span>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="openOfferModal('${req.car_type} ${req.year}', '${req.part_name}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition flex items-center justify-center gap-2">
                            <span>âœ‹</span> Ø¹Ù†Ø¯ÙŠ Ø§Ù„Ù‚Ø·Ø¹Ø©
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        fetchRequests();

        // 2. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø© (Modal)
        window.openOfferModal = (car, part) => {
            currentCarDetails = car;
            currentPartName = part;
            document.getElementById('modalDetails').innerText = `Ø·Ù„Ø¨: ${part} - ${car}`;
            document.getElementById('offerModal').classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('offerModal').classList.add('hidden');
            document.getElementById('offerForm').reset();
            resetFileLabel();
        }

        window.fileSelected = (input) => {
            if (input.files && input.files[0]) {
                const label = document.getElementById('fileLabel');
                label.classList.add('border-green-500', 'bg-green-50');
                label.innerHTML = `<p class="text-green-600 font-bold">âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©</p>`;
            }
        }

        function resetFileLabel() {
            document.getElementById('fileLabel').classList.remove('border-green-500', 'bg-green-50');
            document.getElementById('fileLabel').innerHTML = `<div class="flex flex-col items-center justify-center pt-5 pb-6"><p class="text-sm text-gray-500 font-bold">Ø§Ø¶ØºØ· Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹Ø©</p></div><input type="file" id="fileInput" class="hidden" onchange="fileSelected(this)" required accept="image/*" />`;
        }

        // 3. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
        window.submitOffer = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            const price = document.getElementById('priceInput').value;
            const file = document.getElementById('fileInput').files[0];

            if (!file) return alert("Ø§Ù„ØµÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨Ø©!");

            btn.disabled = true;
            btn.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

            try {
                // Ø£) Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Supabase Storage
                // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù„ÙŠÙƒÙˆÙ† Ù…Ù…ÙŠØ²Ø§Ù‹
                const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('offers') // Ø§Ø³Ù… Ø§Ù„Ù€ Bucket Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£Ù†Ø§Ù‡
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ØµÙˆØ±Ø©
                const { data: { publicUrl } } = supabase.storage
                    .from('offers')
                    .getPublicUrl(fileName);

                // Ø¨) Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ offers
                const { error: dbError } = await supabase
                    .from('offers')
                    .insert([
                        {
                            car_details: currentCarDetails,
                            part_name: currentPartName,
                            price: Number(price),
                            image_url: publicUrl,
                            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© request_id Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø±Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯Ù‚Ø©
                        }
                    ]);

                if (dbError) throw dbError;

                closeModal();
                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­!");

            } catch (error) {
                console.error("Error:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + (error.message || "ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ Bucket ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ Policies"));
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>