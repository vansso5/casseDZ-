<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ - CasseDZ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: 'Cairo', sans-serif; }
@keyframes slide-up { from { transform: translateY(100%); opacity:0; } to { transform: translateY(0); opacity:1; } }
.animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
</style>
</head>
<body class="bg-gray-100 text-gray-800 pb-24">

<header class="bg-gray-900 text-white p-4 sticky top-0 z-50 shadow-lg">
<div class="flex justify-between items-center mb-4">
<div class="text-xl font-black">Casse<span class="text-orange-500">DZ</span> <span class="text-xs font-normal text-gray-400">| Ø´Ø±ÙŠÙƒ</span></div>
<button onclick="logout()" class="bg-gray-800 p-2 rounded-full border border-gray-700 hover:bg-red-600 transition" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-300 hover:text-white">
<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
</svg>
</button>
</div>

<div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-4 shadow-lg flex justify-between items-center relative overflow-hidden">
<div class="relative z-10">
<p class="text-blue-200 text-xs font-bold mb-1">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
<h2 class="text-3xl font-black text-white">1,500 <span class="text-sm font-normal">Ø¯Ø¬</span></h2>
</div>
<div class="text-center bg-white/10 p-2 rounded-lg backdrop-blur-sm relative z-10">
<p class="text-xs text-blue-100">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</p>
<span class="text-green-400 font-bold text-sm flex items-center gap-1">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
<path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" />
</svg>
Ù†Ø´Ø·
</span>
</div>
</div>
</header>

<div class="px-4 mt-4">
<div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
<button class="bg-gray-900 text-white px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap shadow-md flex items-center gap-2">ğŸ”¥ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
<button class="bg-white text-gray-600 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap border flex items-center gap-2">Ø³ÙŠØ§Ø±Ø§Øª ÙØ±Ù†Ø³ÙŠØ©</button>
<button class="bg-white text-gray-600 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap border flex items-center gap-2">Ø³ÙŠØ§Ø±Ø§Øª Ø£Ù„Ù…Ø§Ù†ÙŠØ©</button>
</div>
</div>

<main id="requestsFeed" class="container mx-auto px-4 mt-4 space-y-4 pb-20">
<div id="loadingIndicator" class="text-center py-10">
<div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
<p class="mt-3 text-gray-500 font-bold text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†...</p>
</div>
</main>

<div id="offerModal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-end md:items-center justify-center">
<div class="bg-white w-full md:w-96 rounded-t-3xl md:rounded-3xl p-6 animate-slide-up">
<div class="flex justify-between items-center mb-6 border-b pb-4">
<h3 class="text-xl font-black text-gray-900">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</h3>
<button onclick="closeModal()" class="bg-gray-100 w-8 h-8 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600 font-bold flex items-center justify-center">âœ•</button>
</div>
<div id="modalDetails" class="bg-blue-50 p-3 rounded-xl mb-4 text-sm font-bold text-blue-800 border border-blue-100"></div>
<form onsubmit="submitOffer(event)" class="space-y-4">
<div>
<label class="block text-sm font-bold text-gray-700 mb-2">Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙŠÙ†Ø§Ø±)</label>
<div class="relative">
<input type="number" id="priceInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: 12000" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg" required>
<span class="absolute left-4 top-4 text-gray-400 font-bold text-sm">DZD</span>
</div>
</div>
<div>
<label class="block text-sm font-bold text-gray-700 mb-2">ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø·Ø¹Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
<label id="fileLabel" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
<div class="flex flex-col items-center justify-center pt-5 pb-6">
<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
<p class="text-sm text-gray-500 font-bold">Ø§Ø¶ØºØ· Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹Ø©</p>
</div>
<input type="file" id="fileInput" class="hidden" onchange="fileSelected(this)" required accept="image/*" />
</label>
</div>
<button type="submit" id="submitBtn" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg mt-2 text-lg hover:bg-black">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø²Ø¨ÙˆÙ†</button>
</form>
</div>
</div>

<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 flex justify-between items-center z-40">
<a href="seller.html" class="flex flex-col items-center gap-1 p-2 text-blue-600 transition"><span class="text-2xl">ğŸ </span><span class="text-[10px] font-bold">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
<a href="seller-offers.html" class="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition"><span class="text-2xl">ğŸ“‹</span><span class="text-[10px] font-bold">Ø·Ù„Ø¨Ø§ØªÙŠ</span></a>
<a href="seller-sales.html" class="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition"><span class="text-2xl">ğŸ’°</span><span class="text-[10px] font-bold">Ø§Ù„Ù…Ø­ÙØ¸Ø©</span></a>
<a href="seller-settings.html" class="flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition"><span class="text-2xl">âš™ï¸</span><span class="text-[10px] font-bold">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a>
</nav>

<script>
const supabaseUrl = 'https://vdxgaxagqvfglodtgoir.supabase.co';
const supabaseKey = 'sb_publishable_vG07Iep-sf7ZlNyq49n-zw_xjeIBMmd';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

let selectedRequestId = null;
let selectedCarDetails = null;
let selectedPartName = null;
let currentUser = null;

async function initPage() {
    const { data: { session } } = await supabase.auth.getSession();
    if(!session){ window.location.href='seller-login.html'; return; }
    currentUser = session.user;
    fetchRequests();
}

async function fetchRequests(){
    const feedContainer=document.getElementById('requestsFeed');
    const loading=document.getElementById('loadingIndicator');
    try{
        const { data,error } = await supabase.from('requests').select('*').order('created_at',{ascending:false});
        if(error) throw error;
        loading.classList.add('hidden');
        if(!data || data.length===0){ 
            feedContainer.innerHTML=`<div class="text-center mt-10 p-5 bg-white rounded-xl shadow"><p class="text-2xl mb-2">ğŸ“­</p><p class="text-gray-500 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>`; 
            return; 
        }
        feedContainer.innerHTML='';
        for(const req of data){
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ø¹Ø±Ø¶ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù† ÙˆØ¬Ø¯
            const { data: lastOffer } = await supabase.from('offers').select('*').eq('request_id', req.id).order('created_at',{ascending:false}).limit(1).single();
            let offerHTML = '';
            if(lastOffer){
                const { data: publicUrl } = supabase.storage.from('offers').getPublicUrl(lastOffer.image_path);
                offerHTML = `
                <div class="mt-2 bg-gray-50 p-3 rounded-xl border border-gray-200 text-sm">
                    <img src="${publicUrl.publicUrl}" class="w-full h-32 object-cover rounded-xl mb-2"/>
                    <p class="font-bold text-gray-700">Ø§Ù„Ø³Ø¹Ø±: ${lastOffer.price} Ø¯Ø¬</p>
                </div>`;
            }
            let timeAgo="Ø§Ù„Ø¢Ù†";
            if(req.created_at){
                const diff=new Date()-new Date(req.created_at);
                const minutes=Math.floor(diff/60000);
                timeAgo=minutes<60?`${minutes} Ø¯`:`${Math.floor(minutes/60)} Ø³`;
            }
            feedContainer.innerHTML+=`
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-200 relative overflow-hidden transition hover:shadow-md mb-4">
                <div class="absolute top-0 left-0 bg-red-100 text-red-600 text-[10px] font-bold px-3 py-1 rounded-br-xl flex items-center gap-1">ğŸ”¥ Ø¬Ø¯ÙŠØ¯</div>
                <div class="flex justify-between items-start mt-2">
                    <div>
                        <h3 class="text-lg font-black text-gray-800">${req.part_name||'Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©'}</h3>
                        <p class="text-gray-500 font-bold text-sm">${req.car_type||'Ø³ÙŠØ§Ø±Ø©'} â€¢ ${req.year||''}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded-lg text-center min-w-[60px]">
                        <span class="block text-xs text-gray-400">Ù…Ù†</span>
                        <span class="block text-sm font-bold text-gray-800">${req.city||'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'}</span>
                    </div>
                </div>
                <p class="text-gray-500 text-xs mt-2">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù†Ø°: ${timeAgo}</p>
                <button onclick="openModal('${req.id}','${req.car_type}','${req.part_name}')" class="mt-3 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶</button>
                ${offerHTML}
            </div>`;
        }
    }catch(err){
        console.error(err);
        feedContainer.innerHTML=`<div class="text-center mt-10 p-5 bg-red-50 rounded-xl shadow"><p class="text-red-500 font-bold">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p></div>`;
    }
}

function openModal(requestId, carType, partName){
    selectedRequestId=requestId;
    selectedCarDetails=carType;
    selectedPartName=partName;
    document.getElementById('modalDetails').innerText=`${carType} - ${partName}`;
    document.getElementById('offerModal').classList.remove('hidden');
}

function closeModal(){
    document.getElementById('offerModal').classList.add('hidden');
    document.getElementById('priceInput').value='';
    document.getElementById('fileInput').value='';
    document.getElementById('fileLabel').innerHTML=`<div class="flex flex-col items-center justify-center pt-5 pb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    <p class="text-sm text-gray-500 font-bold">Ø§Ø¶ØºØ· Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹Ø©</p>
    </div>`;
}

function fileSelected(input){
    const file=input.files[0];
    if(!file) return;
    document.getElementById('fileLabel').innerHTML=`<img src="${URL.createObjectURL(file)}" class="w-full h-32 object-cover rounded-xl"/>`;
}

async function submitOffer(e){
    e.preventDefault();
    const price=document.getElementById('priceInput').value;
    const file=document.getElementById('fileInput').files[0];
    if(!file){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©'); return; }

    const fileExt=file.name.split('.').pop();
    const fileName=`offers/${selectedRequestId}_${Date.now()}.${fileExt}`;
    const { error: uploadError } = await supabase.storage.from('offers').upload(fileName, file);
    if(uploadError){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©'); return; }

    const { error: insertError } = await supabase.from('offers').insert([{
        request_id: selectedRequestId,
        seller_id: currentUser.id,
        price: price,
        image_path: fileName,
        created_at: new Date()
    }]);
    if(insertError){ alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶'); return; }

    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­ ğŸš€');
    closeModal();
    fetchRequests(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
}

async function logout(){
    await supabase.auth.signOut();
    window.location.href='seller-login.html';
}

initPage();
</script>
</body>
</html>