<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ - CasseDZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style> body { font-family: 'Cairo', sans-serif; } </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm py-4 sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-blue-700">Casse<span class="text-orange-500">DZ</span></h1>
            <a href="index.html" class="text-xs font-bold bg-gray-100 px-3 py-2 rounded-xl">ğŸ”™ Ø¹ÙˆØ¯Ø©</a>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-8 mb-20 max-w-lg mx-auto">
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="loginSection" class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 text-center">
            <h2 class="text-xl font-black mb-2 text-gray-900">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ ğŸ”</h2>
            <p class="text-gray-500 mb-6 text-sm">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ.</p>
            
            <div class="space-y-4">
                <input type="tel" id="phoneInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (055...)" class="w-full p-4 bg-gray-50 border rounded-xl font-bold text-lg text-left dir-ltr">
                <input type="number" id="codeInput" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ (PIN)" class="w-full p-4 bg-gray-50 border rounded-xl font-black text-3xl text-center">
                
                <!-- Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ø³Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø®ØªÙ„ÙØ© -->
                <button id="realLoginBtn" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg text-lg hover:bg-black transition">
                    ğŸ”“ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </div>
            <p id="statusMsg" class="text-red-500 font-bold mt-4 text-sm"></p>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶ -->
        <div id="offersSection" class="hidden space-y-6">
            <div class="bg-blue-600 text-white p-6 rounded-3xl shadow-xl">
                <p class="text-blue-200 text-xs font-bold mb-1">Ø·Ù„Ø¨Ùƒ:</p>
                <h3 id="displayPartName" class="text-2xl font-black">...</h3>
                <p id="displayCarInfo" class="text-sm opacity-80">...</p>
            </div>
            <h3 class="font-bold text-gray-700">Ø§Ù„Ø±Ø¯ÙˆØ¯:</h3>
            <div id="offersContainer" class="space-y-4"></div>
            <div id="noOffersMsg" class="hidden text-center py-10 border border-dashed rounded-3xl text-gray-400">Ù…Ø§Ø²Ø§Ù„ Ù…Ø§ÙƒØ§Ù†Ø´ Ø¹Ø±ÙˆØ¶ â³</div>
        </div>
    </main>

    <script>
        // 1. Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙŠ Ø®Ø·Ø£ Ø¨Ø±Ù…Ø¬ÙŠ ÙÙˆØ±Ø§Ù‹
        window.onerror = function(msg, url, line) {
            alert("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯:\n" + msg);
            document.getElementById('statusMsg').innerText = "Ø®Ø·Ø£: " + msg;
        };

        // 2. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©
        document.addEventListener('DOMContentLoaded', function() {
            
            // Ø±ÙˆØ§Ø¨Ø· Supabase
            const supabaseUrl = 'https://vdxgaxagqvfglodtgoir.supabase.co';
            const supabaseKey = 'sb_publishable_vG07Iep-sf7ZlNyq49n-zw_xjeIBMmd';
            
            let supabase;
            try {
                const { createClient } = window.supabase;
                supabase = createClient(supabaseUrl, supabaseKey);
                console.log("Supabase Ø¬Ø§Ù‡Ø²");
            } catch (err) {
                alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Supabase: " + err.message);
            }

            // Ø±Ø¨Ø· Ø§Ù„Ø²Ø± (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©)
            const btn = document.getElementById('realLoginBtn');
            
            btn.addEventListener('click', async function() {
                // 3. ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø²Ø±
                const status = document.getElementById('statusMsg');
                status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
                
                const phone = document.getElementById('phoneInput').value;
                const code = document.getElementById('codeInput').value;

                if (!phone || !code) {
                    status.innerText = "âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ÙƒÙˆØ¯!";
                    alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ÙƒÙˆØ¯!");
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = "â³ Ø¯Ù‚ÙŠÙ‚Ø©...";

                try {
                    // 4. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨
                    const { data: requests, error } = await supabase
                        .from('requests')
                        .select('*')
                        .eq('phone', phone)
                        .eq('secret_code', code);

                    if (error) throw error;

                    if (!requests || requests.length === 0) {
                        status.innerText = "âŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©";
                        alert("Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„ÙƒÙˆØ¯");
                        btn.disabled = false;
                        btn.innerHTML = "ğŸ”“ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¯Ø®ÙˆÙ„";
                        return;
                    }

                    const request = requests[0];
                    status.innerText = "âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„! Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø±ÙˆØ¶...";

                    // 5. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø±ÙˆØ¶
                    const { data: offers, error: offersError } = await supabase
                        .from('offers')
                        .select('*')
                        .eq('request_id', request.id);

                    if (offersError) throw offersError;

                    // 6. Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('offersSection').classList.remove('hidden');

                    document.getElementById('displayPartName').innerText = request.part_name || 'Ù‚Ø·Ø¹Ø©';
                    document.getElementById('displayCarInfo').innerText = `${request.car_type} â€¢ ${request.year}`;

                    const container = document.getElementById('offersContainer');
                    const noOffersMsg = document.getElementById('noOffersMsg');
                    container.innerHTML = '';

                    if (!offers || offers.length === 0) {
                        noOffersMsg.classList.remove('hidden');
                    } else {
                        noOffersMsg.classList.add('hidden');
                        offers.forEach(offer => {
                            const isAccepted = offer.status === 'accepted';
                            let actionBtn = '';

                            if (isAccepted) {
                                actionBtn = `<a href="tel:${offer.seller_phone}" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow animate-pulse">ğŸ“ Ø§ØªØµÙ„: ${offer.seller_phone}</a>`;
                            } else {
                                // Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„
                                actionBtn = `<button id="btn-${offer.id}" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow">âœ… Ù‚Ø¨ÙˆÙ„</button>`;
                            }

                            const html = `
                                <div class="bg-white p-4 rounded-2xl shadow border flex gap-4">
                                    <div class="w-20 h-20 bg-gray-200 rounded-lg overflow-hidden">
                                        <img src="${offer.image_url}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-sm text-gray-900">ÙˆØ±Ø´Ø© Ø´Ø±ÙŠÙƒØ©</p>
                                        <div class="flex justify-between items-end mt-2">
                                            <p class="text-xl font-black text-blue-700">${offer.price} Ø¯Ø¬</p>
                                            ${actionBtn}
                                        </div>
                                    </div>
                                </div>
                            `;
                            container.innerHTML += html;

                            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
                            setTimeout(() => {
                                const acceptBtn = document.getElementById(`btn-${offer.id}`);
                                if(acceptBtn) {
                                    acceptBtn.addEventListener('click', async () => {
                                        if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡ØŸ")) return;
                                        await supabase.from('offers').update({ status: 'accepted' }).eq('id', offer.id);
                                        alert("ØªÙ…! Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø¨Ø§Ø¦Ø¹.");
                                        location.reload();
                                    });
                                }
                            }, 100);
                        });
                    }

                } catch (err) {
                    console.error(err);
                    alert("Ø®Ø·Ø£: " + err.message);
                    status.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…";
                    btn.disabled = false;
                    btn.innerHTML = "ğŸ”“ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¯Ø®ÙˆÙ„";
                }
            });
        });
    </script>
</body>
</html>